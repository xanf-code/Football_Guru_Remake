import 'dart:async';import 'dart:io';import 'package:cached_network_image/cached_network_image.dart';import 'package:cloud_firestore/cloud_firestore.dart';import 'package:firebase_storage/firebase_storage.dart';import 'package:flutter/material.dart';import 'package:flutter/scheduler.dart';import 'package:flutter/services.dart';import 'package:flutter_vector_icons/flutter_vector_icons.dart';import 'package:google_fonts/google_fonts.dart';import 'package:image_picker/image_picker.dart';import 'package:lottie/lottie.dart';import 'package:provider/provider.dart';import 'package:transfer_news/Pages/home.dart';import 'package:transfer_news/Repo/repo.dart';import 'package:transfer_news/Utils/constants.dart';import 'package:transfer_news/Widgets/allChatWidgets.dart';import 'package:uuid/uuid.dart';class ChatPage extends StatefulWidget {  final String reference;  final String title;  final String Image;  final BuildContext chatScreenContext;  const ChatPage(      {Key key, this.reference, this.title, this.Image, this.chatScreenContext})      : super(key: key);  @override  _ChatPageState createState() => _ChatPageState();}class _ChatPageState extends State<ChatPage> {  TextEditingController chatTextEditingController = TextEditingController();  var _formKey = GlobalKey<FormState>();  final ScrollController _controller = ScrollController();  String msgID = Uuid().v4();  File selectedImage;  File fileImage;  bool uploading = false;  final ScrollController _scrollController = ScrollController();  int _limit = 20;  final int _limitIncrement = 20;  _scrollListener() {    if (_scrollController.position.pixels ==        _scrollController.position.maxScrollExtent) {      setState(() {        _limit += _limitIncrement;      });    }  }  void initState() {    super.initState();    _scrollController.addListener(_scrollListener);  }  displayChats() {    return StreamBuilder(      stream: context.watch<Repository>().getMessages(widget.reference, _limit),      builder: (context, AsyncSnapshot dataSnapshot) {        if (!dataSnapshot.hasData) {          return Center(            child: CircularProgressIndicator(),          );        }        List<Chats> chats = [];        dataSnapshot.data.documents.forEach(          (document) {            chats.add(Chats.fromDocument(document));          },        );        return GestureDetector(          onTap: () => FocusScope.of(context).unfocus(),          child: ListView(            reverse: true,            controller: _scrollController,            physics: ClampingScrollPhysics(),            children: chats,          ),        );      },    );  }  @override  void dispose() {    _controller.dispose();    _scrollController.dispose();    super.dispose();  }  @override  Widget build(BuildContext context) {    return Scaffold(      backgroundColor: Color(0xFF0e0e10),      appBar: AppBar(        backgroundColor: Color(0xFF0e0e10),        title: Row(          children: [            CircleAvatar(              radius: 15,              backgroundImage: CachedNetworkImageProvider(                widget.Image,              ),            ),            SizedBox(              width: 10,            ),            Text(widget.title),          ],        ),        actions: [          StreamBuilder(            stream: FirebaseFirestore.instance                .collection("ChatsCollection")                .doc(widget.reference)                .snapshots(),            builder: (context, AsyncSnapshot<DocumentSnapshot> snapshot) {              if (!snapshot.hasData) {                return SizedBox();              }              return snapshot.data["lockChat"] == false                  ? Visibility(                      visible: snapshot.data["groupCreatorID"] == currentUser.id                          ? true                          : false,                      child: IconButton(                        icon: Icon(                          Feather.unlock,                          size: 20,                          color: Colors.white,                        ),                        onPressed: () {                          HapticFeedback.heavyImpact();                          FirebaseFirestore.instance                              .collection("ChatsCollection")                              .doc(widget.reference)                              .update({                            "lockChat": true,                          });                        },                      ),                    )                  : Visibility(                      visible: snapshot.data["groupCreatorID"] == currentUser.id                          ? true                          : false,                      child: IconButton(                        icon: Icon(                          Feather.lock,                          size: 20,                          color: Colors.red,                        ),                        onPressed: () {                          HapticFeedback.heavyImpact();                          FirebaseFirestore.instance                              .collection("ChatsCollection")                              .doc(widget.reference)                              .update({                            "lockChat": false,                          });                        },                      ),                    );            },          ),        ],      ),      body: selectedImage == null          ? Form(              key: _formKey,              child: Column(                mainAxisAlignment: MainAxisAlignment.start,                crossAxisAlignment: CrossAxisAlignment.start,                children: [                  SizedBox(                    height: 10,                  ),                  Expanded(                    child: displayChats(),                  ),                  StreamBuilder(                    stream: FirebaseFirestore.instance                        .collection("ChatsCollection")                        .doc(widget.reference)                        .snapshots(),                    builder:                        (context, AsyncSnapshot<DocumentSnapshot> snapshot) {                      if (!snapshot.hasData) {                        return SizedBox();                      }                      return snapshot.data["lockChat"] == false                          ? ListTile(                              title: TextFormField(                                textCapitalization:                                    TextCapitalization.sentences,                                style: GoogleFonts.rubik(                                  color: Colors.white,                                ),                                validator: (String value) {                                  if (value.isEmpty) {                                    return "This field cannot be empty!";                                  } else {                                    return null;                                  }                                },                                controller: chatTextEditingController,                                decoration: InputDecoration(                                  hintText: "Type a message",                                  suffixIcon: IconButton(                                    splashRadius: 1,                                    splashColor: Colors.transparent,                                    icon: Icon(                                      MaterialCommunityIcons.sticker_emoji,                                      color: Colors.white,                                    ),                                    onPressed: () {                                      HapticFeedback.mediumImpact();                                      showModalBottomSheet(                                        context: context,                                        shape: RoundedRectangleBorder(                                          borderRadius: BorderRadius.vertical(                                              top: Radius.circular(25.0)),                                        ),                                        builder: (BuildContext context) {                                          return Container(                                            height: 300,                                            color: appBG,                                            child: Column(                                              mainAxisAlignment:                                                  MainAxisAlignment                                                      .spaceBetween,                                              children: [                                                Row(                                                  mainAxisAlignment:                                                      MainAxisAlignment                                                          .spaceEvenly,                                                  crossAxisAlignment:                                                      CrossAxisAlignment.start,                                                  children: [                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_tx6csxfc.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets1.lottiefiles.com/animated_stickers/lf_tgs_tx6csxfc.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_szvzkb93.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_szvzkb93.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_ickoxspy.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets1.lottiefiles.com/animated_stickers/lf_tgs_ickoxspy.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_z80js1db.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets1.lottiefiles.com/animated_stickers/lf_tgs_z80js1db.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_cbvvq9cn.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_cbvvq9cn.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_23su26ar.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_23su26ar.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets2.lottiefiles.com/animated_stickers/lf_tgs_ep4m7qpx.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets2.lottiefiles.com/animated_stickers/lf_tgs_ep4m7qpx.json",                                                      ),                                                    ),                                                  ],                                                ),                                                Row(                                                  mainAxisAlignment:                                                      MainAxisAlignment                                                          .spaceEvenly,                                                  crossAxisAlignment:                                                      CrossAxisAlignment.start,                                                  children: [                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_ruldvfez.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets1.lottiefiles.com/animated_stickers/lf_tgs_ruldvfez.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_mmszpbcv.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_mmszpbcv.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_x95qusfa.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets1.lottiefiles.com/animated_stickers/lf_tgs_x95qusfa.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_vgqbyel7.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets1.lottiefiles.com/animated_stickers/lf_tgs_vgqbyel7.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_1dr3a5qa.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_1dr3a5qa.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_6fzdmz9y.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets1.lottiefiles.com/animated_stickers/lf_tgs_6fzdmz9y.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets8.lottiefiles.com/animated_stickers/lf_tgs_2a9xxigy.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets8.lottiefiles.com/animated_stickers/lf_tgs_2a9xxigy.json",                                                      ),                                                    ),                                                  ],                                                ),                                                Row(                                                  mainAxisAlignment:                                                      MainAxisAlignment                                                          .spaceEvenly,                                                  crossAxisAlignment:                                                      CrossAxisAlignment.start,                                                  children: [                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets2.lottiefiles.com/animated_stickers/lf_tgs_fhiz0fdc.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets2.lottiefiles.com/animated_stickers/lf_tgs_fhiz0fdc.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_d3mnuzm6.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_d3mnuzm6.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_yi6gwkwu.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets9.lottiefiles.com/animated_stickers/lf_tgs_yi6gwkwu.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_pdiwfsem.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets9.lottiefiles.com/animated_stickers/lf_tgs_pdiwfsem.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_t1rudc8k.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_t1rudc8k.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_e7wyteyu.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_e7wyteyu.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_vah0ocru.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets9.lottiefiles.com/animated_stickers/lf_tgs_vah0ocru.json",                                                      ),                                                    ),                                                  ],                                                ),                                                Row(                                                  mainAxisAlignment:                                                      MainAxisAlignment                                                          .spaceEvenly,                                                  crossAxisAlignment:                                                      CrossAxisAlignment.start,                                                  children: [                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets8.lottiefiles.com/animated_stickers/lf_tgs_blrJs3.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets8.lottiefiles.com/animated_stickers/lf_tgs_blrJs3.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets8.lottiefiles.com/animated_stickers/lf_tgs_S9BQDc.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets8.lottiefiles.com/animated_stickers/lf_tgs_S9BQDc.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets2.lottiefiles.com/animated_stickers/lf_tgs_gpunatuf.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets2.lottiefiles.com/animated_stickers/lf_tgs_gpunatuf.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets10.lottiefiles.com/animated_stickers/lf_tgs_nobhtmub.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            'https://assets10.lottiefiles.com/animated_stickers/lf_tgs_nobhtmub.json',                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets7.lottiefiles.com/animated_stickers/lf_tgs_YHLXSF.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets7.lottiefiles.com/animated_stickers/lf_tgs_YHLXSF.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets8.lottiefiles.com/animated_stickers/lf_tgs_aaasnorq.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets8.lottiefiles.com/animated_stickers/lf_tgs_aaasnorq.json",                                                      ),                                                    ),                                                    GestureDetector(                                                      onTap: () {                                                        Navigator.pop(context);                                                        saveChat(                                                          url: "",                                                          sticker:                                                              "https://assets10.lottiefiles.com/animated_stickers/lf_tgs_z6uyy9m8.json",                                                        );                                                      },                                                      child: tapSticker(                                                        sticker:                                                            "https://assets10.lottiefiles.com/animated_stickers/lf_tgs_z6uyy9m8.json",                                                      ),                                                    ),                                                  ],                                                ),                                              ],                                            ),                                          );                                        },                                      );                                    },                                  ),                                  hintStyle:                                      GoogleFonts.rubik(color: Colors.white),                                  border: OutlineInputBorder(                                    borderRadius: BorderRadius.all(                                      Radius.circular(50),                                    ),                                    borderSide: BorderSide.none,                                  ),                                  contentPadding: EdgeInsets.symmetric(                                    horizontal: 20,                                    vertical: 5,                                  ),                                  filled: true,                                  fillColor: Colors.grey[900],                                ),                              ),                              trailing: GestureDetector(                                onTap: () {                                  setState(() {                                    if (_formKey.currentState.validate()) {                                      saveChat(                                        url: "",                                        sticker: "",                                      );                                    }                                  });                                  //FocusScope.of(context).unfocus();                                  SchedulerBinding.instance                                      .addPostFrameCallback((_) {                                    _controller.animateTo(                                      _controller.position.maxScrollExtent,                                      duration:                                          const Duration(milliseconds: 300),                                      curve: Curves.easeOut,                                    );                                  });                                },                                child: Container(                                  height: 45,                                  width: 45,                                  decoration: new BoxDecoration(                                    shape: BoxShape.circle,                                    gradient: new LinearGradient(                                      colors: [                                        const Color(0xFF3366FF),                                        const Color(0xFF00CCFF),                                      ],                                    ),                                  ),                                  child: Center(                                    child: Icon(                                      FontAwesome.send_o,                                      color: Colors.white,                                      size: 18,                                    ),                                  ),                                ),                              ),                              leading: GestureDetector(                                onTap: () {                                  HapticFeedback.mediumImpact();                                  captureImageWithGallery();                                },                                child: Container(                                  height: 45,                                  width: 45,                                  decoration: new BoxDecoration(                                    shape: BoxShape.circle,                                    gradient: new LinearGradient(                                      colors: [                                        const Color(0xFF3366FF),                                        const Color(0xFF00BCFF),                                      ],                                    ),                                  ),                                  child: Center(                                    child: Icon(                                      Feather.image,                                      color: Colors.white,                                      size: 18,                                    ),                                  ),                                ),                              ),                            )                          : Padding(                              padding: const EdgeInsets.symmetric(                                vertical: 12,                              ),                              child: SizedBox(                                child: Row(                                  mainAxisAlignment: MainAxisAlignment.center,                                  children: [                                    Icon(                                      Icons.lock,                                      color: Colors.white,                                      size: 16,                                    ),                                    SizedBox(                                      width: 6,                                    ),                                    Text(                                      "No one can send message here",                                      style: TextStyle(                                        color: Colors.white,                                      ),                                    ),                                  ],                                ),                              ),                            );                    },                  ),                ],              ),            )          : Stack(              children: [                Form(                  key: _formKey,                  child: Column(                    mainAxisAlignment: MainAxisAlignment.start,                    crossAxisAlignment: CrossAxisAlignment.start,                    children: [                      SizedBox(                        height: 10,                      ),                      Expanded(                        child: displayChats(),                      ),                      ListTile(                        title: TextFormField(                          textCapitalization: TextCapitalization.sentences,                          keyboardType: TextInputType.multiline,                          style: GoogleFonts.rubik(                            color: Colors.white,                          ),                          validator: (String value) {                            if (value.isEmpty) {                              return "This field cannot be empty!";                            } else {                              return null;                            }                          },                          controller: chatTextEditingController,                          decoration: InputDecoration(                            hintText: "Type a message",                            hintStyle: GoogleFonts.rubik(color: Colors.white),                            border: OutlineInputBorder(                                borderRadius: BorderRadius.all(                                  Radius.circular(50),                                ),                                borderSide: BorderSide.none),                            // focusedBorder: InputBorder.none,                            // enabledBorder: InputBorder.none,                            contentPadding: EdgeInsets.symmetric(                              horizontal: 20,                              vertical: 5,                            ),                            filled: true,                            fillColor: Colors.grey[900],                          ),                        ),                        trailing: GestureDetector(                          onTap: () {                            setState(() {                              if (_formKey.currentState.validate()) {                                controlUploadAndSave();                              }                            });                            SchedulerBinding.instance.addPostFrameCallback((_) {                              _controller.animateTo(                                _controller.position.maxScrollExtent,                                duration: const Duration(milliseconds: 300),                                curve: Curves.easeOut,                              );                            });                          },                          child: Container(                            height: 45,                            width: 45,                            decoration: new BoxDecoration(                              shape: BoxShape.circle,                              gradient: new LinearGradient(                                colors: [                                  const Color(0xFF3366FF),                                  const Color(0xFF00CCFF),                                ],                              ),                            ),                            child: Center(                              child: Icon(                                FontAwesome.send_o,                                color: Colors.white,                                size: 18,                              ),                            ),                          ),                        ),                        leading: GestureDetector(                          onTap: () {                            HapticFeedback.mediumImpact();                            captureImageWithGallery();                          },                          child: Container(                            height: 45,                            width: 45,                            decoration: new BoxDecoration(                              shape: BoxShape.circle,                              gradient: new LinearGradient(                                colors: [                                  const Color(0xFF3366FF),                                  const Color(0xFF00BCFF),                                ],                              ),                            ),                            child: Center(                              child: Icon(                                Feather.image,                                color: Colors.white,                                size: 18,                              ),                            ),                          ),                        ),                      ),                    ],                  ),                ),                Positioned(                  bottom: 70,                  left: 20,                  child: Stack(                    children: [                      Container(                        width: MediaQuery.of(context).size.width / 2,                        height: 100,                        color: Colors.white,                        child: Card(                          color: Colors.white,                          child: Container(                            height: 80,                            width: 80,                            color: Colors.black,                            child: Image.file(selectedImage),                          ),                        ),                      ),                      Positioned(                        right: 0,                        child: IconButton(                          icon: Icon(                            Icons.close,                            color: Colors.white,                          ),                          onPressed: () {                            HapticFeedback.mediumImpact();                            setState(() {                              selectedImage = null;                            });                          },                        ),                      ),                      uploading                          ? Positioned.fill(                              child: Align(                                alignment: Alignment.center,                                child: Container(                                  decoration: BoxDecoration(                                    color: Colors.white70,                                    borderRadius: BorderRadius.circular(10),                                  ),                                  child: Padding(                                    padding: const EdgeInsets.all(8.0),                                    child: CircularProgressIndicator(                                      backgroundColor: Colors.black,                                    ),                                  ),                                ),                              ),                            )                          : Text(""),                    ],                  ),                ),              ],            ),    );  }  Future captureImageWithGallery() async {    fileImage = await ImagePicker.pickImage(source: ImageSource.gallery);    if (fileImage != null) {      setState(() {        selectedImage = fileImage;      });    }  }  Future<String> uploadImage(mImageFile) async {    StorageUploadTask mStorageUploadTask =        chatImagesReferences.child("message_$msgID.jpg").putFile(mImageFile);    StorageTaskSnapshot storageTaskSnapshot =        await mStorageUploadTask.onComplete;    String downloadUrl = await storageTaskSnapshot.ref.getDownloadURL();    return downloadUrl;  }  // selected image null  saveChat({String url, String sticker}) {    FirebaseFirestore.instance        .collection("ChatsCollection")        .doc(widget.reference)        .collection("chats")        .doc(msgID)        .set({      "username": currentUser.username,      "chat": chatTextEditingController.text,      "timestamp": DateTime.now(),      "url": currentUser.url,      "likes": [],      "userId": currentUser.id,      "messageID": msgID,      "reference": widget.reference,      "ImageUrl": url,      "sticker": sticker,    });    setState(() {      chatTextEditingController.clear();      msgID = Uuid().v4();      selectedImage = null;      uploading = false;    });  }  controlUploadAndSave() async {    setState(() {      uploading = true;    });    if (selectedImage != null) {      String downloadImage = await uploadImage(selectedImage);      saveChat(        url: downloadImage,        sticker: "",      );    } else {      saveChat(        url: "",        sticker: "",      );    }  }}class tapSticker extends StatelessWidget {  final String sticker;  const tapSticker({    Key key,    this.sticker,  }) : super(key: key);  @override  Widget build(BuildContext context) {    return Padding(      padding: const EdgeInsets.all(        8.0,      ),      child: Container(        height: 50,        width: 50,        child: Lottie.network(          sticker,        ),      ),    );  }}